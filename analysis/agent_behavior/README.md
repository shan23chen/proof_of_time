# Agent Behavior Analysis

Analyze agent execution patterns, failure modes, and stratified sampling of task examples.

## Directory Structure

```
agent_behavior/
├── sample_task_examples_stratified.py  # Main sampling script
├── inputs/                              # (Reserved for future inputs)
├── outputs/                             # Generated analysis outputs
│   ├── sampled_task_examples_stratified/  # Per-task stratified samples
│   ├── all_samples_3way.jsonl            # Combined samples (all tasks)
│   ├── agent_behavior_analysis.jsonl    # Detailed behavior analysis
│   ├── aba_stratum_counts.csv           # Stratum distribution stats
│   ├── aba_failure_taxonomy.csv         # Failure categorization
│   ├── aba_nonconvergence.csv           # Non-convergence analysis
│   └── aba_bottlenecks.csv              # Performance bottlenecks
└── README.md                            # This file
```

## Usage

### Sample Task Examples with Stratification

Sample examples from evaluation logs with 3-way stratification:
- **Complete + Correct**: Agent got right answer, didn't hit message limit
- **Complete + Wrong**: Agent got wrong answer, didn't hit message limit
- **Incomplete**: Agent hit the message limit

```bash
# Sample 2 examples per stratum (default)
python analysis/agent_behavior/sample_task_examples_stratified.py

# Sample more examples per stratum
python analysis/agent_behavior/sample_task_examples_stratified.py --samples-per-stratum 5

# Include no-offline-prompt ablation tasks
python analysis/agent_behavior/sample_task_examples_stratified.py --include-no-offline-prompt

# Save all samples to a single combined file
python analysis/agent_behavior/sample_task_examples_stratified.py \
  --combined-output outputs/all_samples_combined.jsonl
```

**Key Features:**
- Stratified sampling ensures balanced representation across outcomes
- Detects incomplete runs via explicit `sample_limit` events (not ambiguous 'I' status)
- Fallback sampling when strata are empty
- Reproducible sampling with fixed random seed (default: 42)

## Inputs

The script requires summary CSV files in the project root:
- `logs_msg15_summary.csv`
- `logs_msg30_summary.csv`
- `logs_msg50_summary.csv`

These are generated by the main analysis pipeline and contain metadata about evaluation runs.

## Outputs

### Per-Task Samples
`outputs/sampled_task_examples_stratified/{model}__{task}__{msg_limit}.jsonl`

Individual files for each (model, task, message_limit) combination containing stratified samples.

### Combined Samples
`outputs/all_samples_3way.jsonl` (if `--combined-output` specified)

All sampled examples in a single file for comprehensive analysis.

### Statistics Files
Generated by downstream analysis scripts:
- **aba_stratum_counts.csv**: Distribution of samples across 3 strata
- **aba_failure_taxonomy.csv**: Categorized failure modes for wrong completions
- **aba_nonconvergence.csv**: Analysis of incomplete runs (message limit hit)
- **aba_bottlenecks.csv**: Identified performance bottlenecks

## Advanced Options

```bash
# Disable fallback sampling (fail if stratum is empty)
python analysis/agent_behavior/sample_task_examples_stratified.py --no-fallback

# Use custom random seed
python analysis/agent_behavior/sample_task_examples_stratified.py --seed 123

# Specify custom CSV directory
python analysis/agent_behavior/sample_task_examples_stratified.py --csv-dir /path/to/csvs
```

## Notes

- Excludes simple (zero-shot) tasks by default to focus on agentic behavior
- Excludes `no_offline_prompt` ablation tasks by default (use `--include-no-offline-prompt` to include)
- Sampling is deterministic with fixed seed for reproducibility
- Stratification prevents bias toward common outcomes in downstream analysis
